id,title,description,evidence,impact,recommendation,priority
ISS-001,"Ordem das migrações impede setup limpo","A migração 20250120000000_add_image_url altera `petitions` antes dela existir; como o Supabase executa por ordem lexicográfica, é o primeiro arquivo e falha.","supabase/migrations/20250120000000_add_image_url.sql:2; supabase/migrations/20250915132944_twilight_sea.sql:22","Bloqueia `supabase migration up`, CI/CD e onboarding automático.","Renomear/refixar timestamps ou incorporar o ALTER na migração de criação de `petitions` para que dependências rodem depois.",High
ISS-002,"Admin hardcoded nas migrações","O arquivo 20250917051108_broken_resonance insere um `admin_users` com UUID/email fixo, exigindo que o usuário já exista em `auth.users`.","supabase/migrations/20250917051108_broken_resonance.sql:37-40","Migração falha por violar FK e impede provisionamento em novos ambientes.","Remover o INSERT da migração e criar rotina separada (seed/script) para cadastrar admins conforme o ambiente.",High
ISS-003,"FOREACH sem tratar array nulo","`add_message_sent_column` agrega tabelas com `array_agg`, mas executa `FOREACH` mesmo quando a expressão retorna NULL.","supabase/migrations/20250120000002_add_message_sent_column.sql:12-33","Em bancos vazios a migração lança erro e interrompe o restante do batch.","Encapsular o loop com `COALESCE(table_names, ARRAY[]::text[])` ou condicional que só itera quando existirem tabelas.",High
ISS-004,"Políticas RLS expõem assinaturas para qualquer autenticado","A função `create_signatures_table` concede `GRANT ALL` e políticas `USING (true)` para o papel `authenticated`; o mesmo ocorre em `petition_resources`.","supabase/migrations/20250917_add_mensagem_enviada_fix.sql:48-75; supabase/migrations/20250917_add_petition_resources.sql:16-30","Qualquer usuário logado (mesmo sem estar em `admin_users`) pode ler, inserir, alterar ou excluir dados sensíveis.","Reescrever políticas para validar `EXISTS (SELECT 1 FROM admin_users WHERE user_id = auth.uid())` e limitar privilégios; considerar revogar `GRANT ALL` e usar funções rpc controladas.",High
ISS-005,"Ordenação incorreta nos relatórios","O componente `ReportsChart` tenta ordenar meses convertendo strings pt-BR com `new Date()`.","src/components/ReportsChart.tsx:46","Gera gráficos com meses fora de ordem ou `Invalid Date`, comprometendo análises.","Gerar rótulos baseados em ano/mês numérico ou mapear manualmente o mês para índice antes de ordenar.",Medium
ISS-006,"ProtectedRoute altera estado durante render","Quando `isAdmin` é falso o componente chama `setSigningOut` e `signOut` dentro do corpo renderizado.","src/components/ProtectedRoute.tsx:23-34","Provoca warnings do React, possíveis loops e dificulta testes automatizados.","Mover a lógica de sign-out para um `useEffect` que dispare quando `initialized` e `!isAdmin`.",Medium
ISS-007,"Login chama signOut no render","A tela de login executa `signOut()` toda vez que detecta usuário sem perfil admin dentro do corpo do componente.","src/pages/Login.tsx:22-24","Requisições redundantes, warnings de render e risco de comportamento inconsistente.","Trocar por `useEffect` dependente de `[user, loading, isAdmin]` para evitar side-effects no render.",Medium
ISS-008,"Script de ícones incompatível com ESM","`create-icons.js` usa `require` apesar de `package.json` declarar `"type": "module"`.","create-icons.js:1-2","`node create-icons.js` lança `ReferenceError: require is not defined`.","Converter para ESM (usar `import fs from 'fs'`) ou executar com `node --input-type=commonjs` conforme documentado.",Medium
ISS-009,"Scripts CLI com encoding corrompido","Os logs de `setup-supabase.js`/`verificar-configuracao.js` exibem caracteres substituídos (ex.: `?? Configurando...`).","setup-supabase.js:10","Prejudica entendimento dos passos impressos e gera desconfiança ao rodar automações.","Salvar arquivos como UTF-8 e revisar mensagens para remover caracteres inválidos.",Low
ISS-010,"Backup baseado em localStorage","A página `Settings` lê/escreve apenas chaves `petitions`/`signatures` no `localStorage`, ignorando o banco real.","src/pages/Settings.tsx:6-57","Usuários podem acreditar que exportaram dados, mas nada do Supabase é salvo, gerando risco de perda.","Ou conectar os botões ao Supabase (dump via API) ou remover/ocultar os controles até que um fluxo real exista.",Medium
ISS-011,"Operações de storage exigem service role","`createImageBucket`/`deleteImage` usam o cliente público para criar/remover objetos, algo que exige `service_role`.","src/utils/image-storage.ts:83-108","Chamadas sempre falham e podem expor erros ao usuário final.","Executar essas tarefas em backend privilegiado ou via painel, e expor apenas upload/download com permissões válidas.",High
ISS-012,"Contagem de assinaturas N+1","Dashboard e lista de petições fazem `await` sequencial para cada tabela de assinaturas.","src/pages/Dashboard.tsx:21-24; src/pages/PetitionList.tsx:26-28","Escala mal: latência cresce linearmente com o número de petições.","Usar `Promise.all` ou RPC agregadora que retorne contagens em lote.",Medium
